{% extends "myfinances/base.html" %}
{% load static %}
{% load humanize %}
{% block content %}

<h2 class="text-center mt-3">
  Balance Sheet
  <button class="btn btn-link p-0 ml-2" type="button" data-toggle="collapse" data-target="#quickGuide" aria-expanded="false" aria-controls="quickGuide" title="Show/Hide Quick Guide">
    <span class="badge badge-info">?</span>
  </button>
</h2>

<div class="collapse mt-2 mb-4" id="quickGuide">   <!-- added mb-4 for spacing -->
  <div class="card card-body text-left mx-auto" style="width: 60%;">
    <h5 class="mb-2">How to use this Balance Sheet page</h5>
    <ul class="mb-0">
      <li><strong>Filter your data</strong> using the date range, account, and category selectors above. Click <em>Filter</em> to apply or <em>Reset</em> to clear.</li>
      <li><strong>Active filters</strong> are shown as colored badges so you can see what’s applied at a glance.</li>
      <li><strong>Label summary badges</strong> display totals by label (Income, Expense, etc.). The overall total badge shows your net position in green (positive), red (negative), or gray (zero).</li>
      <li><strong>Chart</strong> visualizes monthly totals by label. Hover over points to see exact values.</li>
      <li><strong>Table</strong> lists each category with its label and total, plus a grand total at the bottom.</li>
    </ul>
  </div>
</div>

<!-- Filter form: date range + account + category -->
<form method="get" class="form-inline justify-content-center mb-3">
  <!-- Date range -->
  <div class="form-group mr-2">
    <label for="start_date" class="mr-2">Start Date</label>
    <input type="date" id="start_date" name="start_date"
           class="form-control form-control-sm text-center"
           value="{{ start_date }}" />
  </div>
  <div class="form-group mr-2">
    <label for="end_date" class="mr-2">End Date</label>
    <input type="date" id="end_date" name="end_date"
           class="form-control form-control-sm text-center"
           value="{{ end_date }}" />
  </div>

  <!-- Account filter -->
  <div class="form-group mr-3">
    <label for="acct_info" class="mr-2">Account</label>
    <select id="acct_info" name="acct_info" class="form-control form-control-sm">
      <option value="">All</option>
      {% for acct in acct_infos %}
        <option value="{{ acct }}" {% if acct == selected_acct %}selected{% endif %}>
          {{ acct }}
        </option>
      {% endfor %}
    </select>
  </div>

  <!-- Category filter -->
  <div class="form-group mr-3">
    <label for="category" class="mr-2">Category</label>
    <select id="category" name="category" class="form-control form-control-sm">
      <option value="all">All Categories</option>
      {% for cat in categories %}
        <option value="{{ cat.name }}" {% if request.GET.category == cat.name %}selected{% endif %}>
          {{ cat.name }}
        </option>
      {% endfor %}
    </select>
  </div>

  <!-- Apply + Reset buttons -->
  <button type="submit" class="btn btn-primary btn-sm mr-2">Filter</button>
  <a href="{% url 'myfinances:balance_sheet' %}" class="btn btn-secondary btn-sm">Reset</a>
</form>

<!-- Active filters summary -->
<div class="d-flex justify-content-center mb-3">
  {% if start_date and end_date %}
    <span class="badge badge-info mr-2">Date: {{ start_date }} – {{ end_date }}</span>
  {% endif %}
  {% if selected_acct %}
    <span class="badge badge-secondary mr-2">Account: {{ selected_acct }}</span>
  {% endif %}
  {% if request.GET.category and request.GET.category != "all" %}
    <span class="badge badge-warning">Category: {{ request.GET.category }}</span>
  {% endif %}
</div>

<!-- Label summary badges -->
<div class="d-flex justify-content-center mb-3">
  {% for item in label_summary %}
    {% if item.total_amount > 0 %}
      <span class="badge badge-success mr-2">
        {{ item.Category__label }}: ${{ item.total_amount|floatformat:2|intcomma }}
      </span>
    {% elif item.total_amount < 0 %}
      <span class="badge badge-danger mr-2">
        {{ item.Category__label }}: ${{ item.total_amount|floatformat:2|intcomma }}
      </span>
    {% else %}
      <span class="badge badge-secondary mr-2">
        {{ item.Category__label }}: ${{ item.total_amount|floatformat:2|intcomma }}
      </span>
    {% endif %}
  {% endfor %}

  <!-- Overall total badge -->
  {% if grand_total > 0 %}
    <span class="badge badge-success ml-3">
      Overall Total: ${{ grand_total|floatformat:2|intcomma }}
    </span>
  {% elif grand_total < 0 %}
    <span class="badge badge-danger ml-3">
      Overall Total: ${{ grand_total|floatformat:2|intcomma }}
    </span>
  {% else %}
    <span class="badge badge-secondary ml-3">
      Overall Total: ${{ grand_total|floatformat:2|intcomma }}
    </span>
  {% endif %}
</div>

<!-- Chart container -->
<div class="d-flex justify-content-center mb-4">
  <div style="width: 40%; height: 300px;">   <!-- balanced ratio -->
    <canvas id="balanceSheetChart"></canvas>
  </div>
</div>

{{ chart_data|json_script:"chart-data" }}

<script>
  const chartData = JSON.parse(document.getElementById("chart-data").textContent);
</script>

<!-- Balance sheet table -->
<div class="d-flex justify-content-center">
  <div class="table-responsive" style="width: 60%;">
    <table id="balanceSheetTable">
      <thead>
        <tr>
          <th onclick="sortTable(0, 'text')">Category ▲▼</th>
          <th onclick="sortTable(1, 'text')">Label ▲▼</th>
          <th onclick="sortTable(2, 'number')">Total ▲▼</th>
        </tr>
      </thead>
      <tbody>
        {% for row in category_totals %}
        <tr>
          <td>
            <a href="{% url 'myfinances:transactions-list' %}?description=&category={{ row.Category__name|urlencode }}">
              {{ row.Category__name|default:"Uncategorized" }}
            </a>
          </td>
          <td>{{ row.Category__label }}</td>
          <td>
            {% if row.total_amount > 0 %}
              <span class="amount-positive">${{ row.total_amount|floatformat:2|intcomma }}</span>
            {% elif row.total_amount < 0 %}
              <span class="amount-negative">${{ row.total_amount|floatformat:2|intcomma }}</span>
            {% else %}
              <span class="amount-zero">${{ row.total_amount|floatformat:2|intcomma }}</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr class="font-weight-bold">
          <td colspan="2" class="text-center">TOTAL</td>
          <td>
            {% if grand_total > 0 %}
              <span class="amount-positive">${{ grand_total|floatformat:2|intcomma }}</span>
            {% elif grand_total < 0 %}
              <span class="amount-negative">${{ grand_total|floatformat:2|intcomma }}</span>
            {% else %}
              <span class="amount-zero">${{ grand_total|floatformat:2|intcomma }}</span>
            {% endif %}
          </td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>


<!-- Load Chart.js library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<!-- Load your custom script -->
<script type="text/javascript" src="{% static 'myfinances/js/balance_sheet_chart.js' %}"></script>

<script>
let sortDirections = {};

function sortTable(colIndex, type) {
  const table = document.getElementById("balanceSheetTable");
  const tbody = table.tBodies[0];
  const rows = Array.from(tbody.querySelectorAll("tr"));

  // Toggle sort direction per column
  sortDirections[colIndex] = !sortDirections[colIndex];
  const ascending = sortDirections[colIndex];

  rows.sort((a, b) => {
    let aText = a.cells[colIndex].innerText.trim();
    let bText = b.cells[colIndex].innerText.trim();

    if (type === "number") {
      aText = parseFloat(aText.replace(/[$,]/g, "")) || 0;
      bText = parseFloat(bText.replace(/[$,]/g, "")) || 0;
      return ascending ? aText - bText : bText - aText;
    } else {
      return ascending ? aText.localeCompare(bText) : bText.localeCompare(aText);
    }
  });

  // Re-append sorted rows (footer untouched)
  rows.forEach(row => tbody.appendChild(row));
}
</script>


{% endblock %}