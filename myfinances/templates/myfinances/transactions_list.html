{% extends "myfinances/base.html" %}
{% load static %}
{% load humanize %}
{% block content %}

<style>
  /* Table styling */
  table {
    width: 60%;
    border-collapse: collapse;
    margin: 20px auto;
    font-family: Arial, sans-serif;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  }
  th {
    background-color: #0c6ba1;
    color: white;
    text-align: center;
    padding: 10px;
    font-size: 16px;
    border-bottom: 2px solid #03131d;
  }
  td {
    padding: 10px;
    border-bottom: 1px solid #ddd;
    font-size: 14px;
    text-align: center;
  }
  tr:hover td { background-color: #66994e; }

  /* Amount styling */
  .amount-positive { color: green; font-weight: bold; }
  .amount-negative { color: red; font-weight: bold; }
  .amount-zero { color: gray; }

  /* Extra spacing between category dropdown and filter button */
  .category-dropdown {
    margin-right: 15px; /* adds space before Filter button */
  }
</style>

<h2 class="text-center mt-3">
  Transactions
  <button class="btn btn-link p-0 ml-2" type="button"
          data-toggle="collapse" data-target="#quickGuide"
          aria-expanded="false" aria-controls="quickGuide"
          title="Show/Hide Quick Guide">
    <span class="badge badge-info">?</span>
  </button>
</h2>

<div class="collapse mt-2 mb-4" id="quickGuide">
  <div class="card card-body text-left mx-auto" style="width: 60%;">
    <h5 class="mb-2">How to use this Transactions page</h5>
    <ul class="mb-0">
      <li><strong>Page size selector</strong> lets you choose how many transactions to display per page.</li>
      <li><strong>Search and filter</strong> by description or category using the form above. Click <em>Filter</em> to apply or <em>Clear</em> to reset.</li>
      <li><strong>Transactions table</strong> shows account info, posting date, description, amount, type, and category. Positive amounts are green, negatives are red.</li>
      <li><strong>Actions</strong> allow you to update or delete a transaction directly from the table.</li>
      <li><strong>Total row</strong> at the bottom shows the sum of all listed transactions.</li>
      <li><strong>Pagination controls</strong> help you navigate between pages. If you select “All,” you’ll see every transaction at once.</li>
    </ul>
  </div>
</div>

<!-- Page size selector -->
<div class="d-flex justify-content-center mb-3">
  <form method="get" class="form-inline">
    <label for="page_size" class="mr-2">Show per page:</label>
    <select id="page_size" name="page_size" class="form-control form-control-sm mr-2" onchange="this.form.submit()">
      <!-- Options for pagination size -->
      <option value="10" {% if current_page_size == '10' %}selected{% endif %}>10</option>
      <option value="20" {% if current_page_size == '20' %}selected{% endif %}>20</option>
      <option value="50" {% if current_page_size == '50' %}selected{% endif %}>50</option>
      <option value="100" {% if current_page_size == '100' %}selected{% endif %}>100</option>
      <option value="all" {% if current_page_size == 'all' %}selected{% endif %}>All</option>
    </select>
    {% if page_obj %}
      <!-- Preserve current page when changing size -->
      <input type="hidden" name="page" value="{{ page_obj.number }}">
    {% endif %}
  </form>
</div>

<!-- Search + Filter Form -->
<form method="get" class="form-inline justify-content-center mb-3">
  <!-- Description search -->
  <input type="text" name="description" class="form-control mr-2"
         placeholder="Search description..."
         value="{{ request.GET.description }}">
  
  <!-- Category dropdown -->
  <select name="category" class="form-control category-dropdown">
    <option value="all">All Categories</option>
    {% for cat in categories %}
      <option value="{{ cat.name }}" {% if request.GET.category == cat.name %}selected{% endif %}>
        {{ cat.name }}
      </option>
    {% endfor %}
  </select>

  <!-- Filter and Clear buttons -->
  <button type="submit" class="btn btn-primary mr-2">Filter</button>
  <a href="{% url 'myfinances:transactions-list' %}" class="btn btn-secondary">Clear</a>
</form>

{% if is_paginated %}
<div class="d-flex flex-column align-items-center mb-3">
  <!-- Pagination info -->
  <div class="badge bg-info text-light mb-2">
    Showing {{ page_obj.start_index }}–{{ page_obj.end_index }} of {{ page_obj.paginator.count }} records
    (Page {{ page_obj.number }} of {{ paginator.num_pages }})
  </div>

  <!-- Pagination controls -->
  <nav aria-label="Transaction pagination">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page=1&page_size={{ paginator.per_page }}&description={{ request.GET.description }}&category={{ request.GET.category }}">&laquo; First</a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}&page_size={{ paginator.per_page }}&description={{ request.GET.description }}&category={{ request.GET.category }}">Previous</a>
        </li>
      {% endif %}

      <li class="page-item disabled">
        <span class="page-link">
          Page {{ page_obj.number }} of {{ paginator.num_pages }}
        </span>
      </li>

      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}&page_size={{ paginator.per_page }}&description={{ request.GET.description }}&category={{ request.GET.category }}">Next</a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?page={{ paginator.num_pages }}&page_size={{ paginator.per_page }}&description={{ request.GET.description }}&category={{ request.GET.category }}">Last &raquo;</a>
        </li>
      {% endif %}
    </ul>
  </nav>
</div>
{% else %}
<!-- When showing all, provide quick navigation -->
<div class="d-flex justify-content-center mt-3">
  <a class="btn btn-outline-secondary btn-sm mr-2" href="?page=1&page_size=20&description={{ request.GET.description }}&category={{ request.GET.category }}">First page (20)</a>
  <a class="btn btn-outline-secondary btn-sm" href="?page=1&page_size=all&description={{ request.GET.description }}&category={{ request.GET.category }}">View all</a>
</div>
{% endif %}

{% if not is_paginated %}
  <div class="mb-4"></div>  {# adds space above the button when pagination is off #}
{% endif %}

<div class="d-flex justify-content-center mb-2">
  <a href="?export=csv{% if active_description %}&description={{ active_description }}{% endif %}{% if active_category %}&category={{ active_category }}{% else %}&category=all{% endif %}{% if current_page_size %}&page_size={{ current_page_size }}{% endif %}"
     class="btn btn-outline-primary btn-sm">
    Export Transactions CSV
  </a>
</div>

<!-- Transactions table -->
<table>
  <thead>
    <tr>
      <th>Acct Info</th>
      <th>Posting Date</th>
      <th>Description</th>
      <th>Amount</th>
      <th>Type</th>
      <th>Category</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    {% for transaction in transactions %}
    <tr>
      <td>{{ transaction.Acct_Info }}</td>
      <td>{{ transaction.Posting_Date }}</td>
      <td>{{ transaction.Description }}</td>
      <td>
        {% if transaction.Amount > 0 %}
          <span class="amount-positive">${{ transaction.Amount|floatformat:2|intcomma }}</span>
        {% elif transaction.Amount < 0 %}
          <span class="amount-negative">${{ transaction.Amount|floatformat:2|intcomma }}</span>
        {% else %}
          <span class="amount-zero">${{ transaction.Amount|floatformat:2|intcomma }}</span>
        {% endif %}
      </td>
      <td>{{ transaction.Type }}</td>
      <td>
        {% if transaction.Category %}
          {{ transaction.Category }}
        {% else %}
          <span class="text-muted">----</span>
        {% endif %}
      </td>
      <td>
        <!-- Update/Delete actions -->
        <a class="btn btn-secondary btn-sm mt-1 mb-1" href="{% url 'myfinances:transactions-update' transaction.id %}">Update</a>
        <a class="btn btn-danger btn-sm mt-1 mb-1" href="{% url 'myfinances:transactions-delete' transaction.id %}">Delete</a>
      </td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="7">No transactions found.</td>
    </tr>
    {% endfor %}
  </tbody>
  <tfoot>
    <tr class="font-weight-bold">
      <td></td> <!-- empty cell under Acct Info -->
      <td></td> <!-- empty cell under Posting Date -->
      <td class="text-center">TOTAL</td> <!-- total label -->
      <td>
        {% if total_amount < 0 %}
          <span class="amount-negative">${{ total_amount|floatformat:2|intcomma }}</span>
        {% else %}
          <span class="amount-positive">${{ total_amount|floatformat:2|intcomma }}</span>
        {% endif %}
      </td>
      <td></td> <!-- empty cell under Type -->
      <td></td> <!-- empty cell under Category -->
      <td></td> <!-- empty cell under Action -->
    </tr>
  </tfoot>
</table>


{% endblock %}